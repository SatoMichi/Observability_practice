# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œåˆ†ææ¼”ç¿’ - Observabilityç ”ä¿®æ•™æ

## ğŸ¯ å­¦ç¿’ç›®æ¨™

ã“ã®æ¼”ç¿’ã§ã¯ã€OpenTelemetryãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ï¼š
1. **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®ç‰¹å®š**ï¼šå®Ÿéš›ã®Spanãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ€§èƒ½å•é¡Œã‚’ç™ºè¦‹
2. **æ ¹æœ¬åŸå› åˆ†æ**ï¼šãªãœãã®å‡¦ç†ãŒé…ã„ã®ã‹ã‚’ç†è§£
3. **æ”¹å–„æ¡ˆã®ç«‹æ¡ˆ**ï¼šå…·ä½“çš„ãªè§£æ±ºç­–ã‚’è€ƒãˆã‚‹
4. **å„ªå…ˆé †ä½ä»˜ã‘**ï¼šå½±éŸ¿åº¦ã®é«˜ã„å•é¡Œã‹ã‚‰è§£æ±ºã™ã‚‹åˆ¤æ–­åŠ›

---

## ğŸ“Š å®Ÿéš›ã®ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿

### slow_tfidf_search ã®æ€§èƒ½å•é¡Œï¼ˆå®Ÿæ¸¬å€¤ï¼‰

```
ğŸ” Span: search_api
   Duration: 1664.55 ms â† å…¨ä½“ã®å‡¦ç†æ™‚é–“
   â””â”€â”€ slow_tfidf_search
       Duration: 1664.30 ms
       â”œâ”€â”€ slow_preprocess_query: 213.65 ms
       â”œâ”€â”€ slow_vectorize_query: 555.02 ms  
       â”œâ”€â”€ slow_compute_similarity: 532.33 ms
       â””â”€â”€ slow_process_results: 362.65 ms
           â”œâ”€â”€ slow_generate_snippet (Ã—5): 60-95ms each
           â””â”€â”€ inefficient_bubble_sort: 12.73 ms
```

**é€šå¸¸ã®TF-IDFæ¤œç´¢**: 414ms  
**é…ã„TF-IDFæ¤œç´¢**: 1664msï¼ˆ**ç´„4å€é…ã„**ï¼‰

---

## ğŸ” ãƒœãƒˆãƒ«ãƒãƒƒã‚¯åˆ†ææ¼”ç¿’

### å•é¡Œ1: å‰å‡¦ç†ã®ç„¡é§„ãªå‡¦ç†

**è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
```json
{
  "span_name": "slow_preprocess_query",
  "duration": 213.65,
  "attributes": {
    "query.original": "blue whale",
    "query.processed": "blue whale", 
    "bottleneck.dummy_operations": 500000
  }
}
```

**ğŸ¤” åˆ†æèª²é¡Œ**:
- ãªãœã€Œblue whaleã€ã¨ã„ã†çŸ­ã„ã‚¯ã‚¨ãƒªã®å‰å‡¦ç†ã«213msã‚‚ã‹ã‹ã‚‹ã®ã‹ï¼Ÿ
- `dummy_operations: 500000` ã¯ä½•ã‚’æ„å‘³ã™ã‚‹ã‹ï¼Ÿ
- ã“ã®å‡¦ç†ã¯æœ¬å½“ã«å¿…è¦ã‹ï¼Ÿ

**ğŸ’¡ æ”¹å–„æ¡ˆ**:
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
for i in range(50000):  # ä¸è¦ãªãƒ«ãƒ¼ãƒ—
    temp_string = processed_query.upper().lower().strip()
time.sleep(0.2)  # ä¸è¦ãªå¾…æ©Ÿ

# âœ… æ”¹å–„å¾Œ
processed_query = preprocess_text(query)  # 1å›ã ã‘å®Ÿè¡Œ
# sleepã‚’å‰Šé™¤
```

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**: 213ms â†’ 1msï¼ˆ**99.5%çŸ­ç¸®**ï¼‰

---

### å•é¡Œ2: é‡è¤‡ã—ãŸãƒ™ã‚¯ãƒˆãƒ«åŒ–å‡¦ç†

**è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
```json
{
  "span_name": "slow_vectorize_query", 
  "duration": 555.02,
  "attributes": {
    "vector.shape": "(1, 5000)",
    "bottleneck.duplicate_vectorizations": 10
  }
}
```

**ğŸ¤” åˆ†æèª²é¡Œ**:
- ãªãœåŒã˜ã‚¯ã‚¨ãƒªã‚’10å›ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã™ã‚‹ã®ã‹ï¼Ÿ
- 1å›ã®å‡¦ç†æ™‚é–“ã¯ç´„55msã€æ®‹ã‚Šã®500msã¯ä½•ï¼Ÿ
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã¸ã®å½±éŸ¿ã¯ï¼Ÿ

**ğŸ’¡ æ”¹å–„æ¡ˆ**:
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰  
query_vector = tfidf_vectorizer.transform([processed_query])
for i in range(10):  # ä¸è¦ãªé‡è¤‡å‡¦ç†
    duplicate_vector = tfidf_vectorizer.transform([processed_query])
    time.sleep(0.05)

# âœ… æ”¹å–„å¾Œ
query_vector = tfidf_vectorizer.transform([processed_query])
# é‡è¤‡å‡¦ç†ã¨sleepã‚’å‰Šé™¤
```

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**: 555ms â†’ 55msï¼ˆ**90%çŸ­ç¸®**ï¼‰

---

### å•é¡Œ3: é¡ä¼¼åº¦è¨ˆç®—ã®ç„¡é§„ãªå†å®Ÿè¡Œ

**è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
```json
{
  "span_name": "slow_compute_similarity",
  "duration": 532.33, 
  "attributes": {
    "similarity.matrix_size": 18,
    "bottleneck.recalculation_operations": 90
  }
}
```

**ğŸ¤” åˆ†æèª²é¡Œ**:
- 18æ–‡æ›¸ã®é¡ä¼¼åº¦è¨ˆç®—ãŒãªãœ532msã‚‚ã‹ã‹ã‚‹ã®ã‹ï¼Ÿ
- `recalculation_operations: 90` ã®æ„å‘³ã¯ï¼Ÿ
- æ­£å¸¸ãªå‡¦ç†æ™‚é–“ã¯ã©ã®ç¨‹åº¦ã‹ï¼Ÿ

**ğŸ’¡ æ”¹å–„æ¡ˆ**:
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
similarities = cosine_similarity(query_vector, tfidf_matrix)
for i in range(5):  # 5å›ã‚‚å†è¨ˆç®—
    temp_similarities = cosine_similarity(query_vector, tfidf_matrix)
    time.sleep(0.1)

# âœ… æ”¹å–„å¾Œ  
similarities = cosine_similarity(query_vector, tfidf_matrix)
# å†è¨ˆç®—ã¨sleepã‚’å‰Šé™¤
```

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**: 532ms â†’ 32msï¼ˆ**94%çŸ­ç¸®**ï¼‰

---

### å•é¡Œ4: ã‚¹ãƒ‹ãƒšãƒƒãƒˆç”Ÿæˆã®éåŠ¹ç‡æ€§

**è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
```json
{
  "span_name": "slow_generate_snippet",
  "duration": 95.63,
  "attributes": {
    "book.id": "melville-moby_dick.txt"
  }
}
```

**ğŸ¤” åˆ†æèª²é¡Œ**:
- é€šå¸¸ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆç”Ÿæˆã¯20-30msã€ãªãœ95msã‚‚ã‹ã‹ã‚‹ã®ã‹ï¼Ÿ
- å„ã‚¹ãƒ‹ãƒšãƒƒãƒˆç”Ÿæˆã®å¾Œã«ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ï¼Ÿ
- ä¸¦åˆ—å‡¦ç†ã¯å¯èƒ½ã‹ï¼Ÿ

**ğŸ’¡ æ”¹å–„æ¡ˆ**:
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰
with tracer.start_as_current_span("slow_generate_snippet"):
    snippet = get_snippet(book_info['raw_text'], query)
    time.sleep(0.03)  # ä¸è¦ãªé…å»¶

# âœ… æ”¹å–„å¾Œ
with tracer.start_as_current_span("generate_snippet"):
    snippet = get_snippet(book_info['raw_text'], query)
    # sleepã‚’å‰Šé™¤

# ğŸš€ ã•ã‚‰ãªã‚‹æ”¹å–„ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰
import asyncio
snippets = await asyncio.gather(*[
    get_snippet_async(book['raw_text'], query) 
    for book in matching_books
])
```

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**: 95msÃ—5 â†’ 25msÃ—5ï¼ˆ**ä¸¦åˆ—å®Ÿè¡Œã§75ms**ï¼‰

---

### å•é¡Œ5: éåŠ¹ç‡ãªã‚½ãƒ¼ãƒˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ   

**è¦³æ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿**:
```json
{
  "span_name": "inefficient_bubble_sort",
  "duration": 12.73,
  "attributes": {
    "bottleneck.bubble_sort_comparisons": 10
  }
}
```

**ğŸ¤” åˆ†æèª²é¡Œ**:
- ãªãœãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã®ã‹ï¼Ÿ
- 10è¦ç´ ã§12.73msã¯é©åˆ‡ã‹ï¼Ÿ
- Pythonã®æ¨™æº–ã‚½ãƒ¼ãƒˆã¨ã®æ¯”è¼ƒã¯ï¼Ÿ

**ğŸ’¡ æ”¹å–„æ¡ˆ**:
```python
# âŒ å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆï¼‰
for i in range(min(n, 50)):
    for j in range(min(n-i-1, 50)):
        if results[j]['score'] < results[j+1]['score']:
            results[j], results[j+1] = results[j+1], results[j]
        time.sleep(0.001)

# âœ… æ”¹å–„å¾Œï¼ˆPythonã®çµ„ã¿è¾¼ã¿ã‚½ãƒ¼ãƒˆï¼‰
results.sort(key=lambda x: x['score'], reverse=True)
```

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**: 12.73ms â†’ 0.1msï¼ˆ**99%çŸ­ç¸®**ï¼‰

---

## ğŸ¯ æ”¹å–„åŠ¹æœã®è©¦ç®—

### å€‹åˆ¥æ”¹å–„åŠ¹æœ

| ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ | ç¾åœ¨ã®æ™‚é–“ | æ”¹å–„å¾Œ | çŸ­ç¸®ç‡ |
|-------------|-----------|---------|--------|
| å‰å‡¦ç† | 213.65ms | 1ms | 99.5% |
| ãƒ™ã‚¯ãƒˆãƒ«åŒ– | 555.02ms | 55ms | 90.1% |
| é¡ä¼¼åº¦è¨ˆç®— | 532.33ms | 32ms | 94.0% |
| ã‚¹ãƒ‹ãƒšãƒƒãƒˆç”Ÿæˆ | 475ms | 75ms | 84.2% |
| ã‚½ãƒ¼ãƒˆ | 12.73ms | 0.1ms | 99.2% |

### ç·åˆæ”¹å–„åŠ¹æœ

**æ”¹å–„å‰**: 1664ms  
**æ”¹å–„å¾Œ**: 163msï¼ˆ**90.2%çŸ­ç¸®**ï¼‰

**ç›®æ¨™é”æˆ**: é€šå¸¸ã®TF-IDFï¼ˆ414msï¼‰ã‚ˆã‚Š**60%é«˜é€ŸåŒ–**

---

## ğŸ† å®Ÿè·µæ¼”ç¿’å•é¡Œ

### ãƒ¬ãƒ™ãƒ«1: åŸºæœ¬åˆ†æ
1. ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã›ã‚ˆ
2. å„Spanã®å®Ÿè¡Œæ™‚é–“ã‚’åˆ†æã—ã€å•é¡Œç®‡æ‰€ã‚’ãƒ©ãƒ³ã‚¯ä»˜ã‘ã›ã‚ˆ
3. `bottleneck.*` å±æ€§ã‹ã‚‰ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ã‚’æ¨æ¸¬ã›ã‚ˆ

### ãƒ¬ãƒ™ãƒ«2: æ ¹æœ¬åŸå› åˆ†æ  
4. ãªãœ `slow_vectorize_query` ãŒ555msã‚‚ã‹ã‹ã‚‹ã®ã‹èª¬æ˜ã›ã‚ˆ
5. `recalculation_operations: 90` ã®è¨ˆç®—æ ¹æ‹ ã‚’ç¤ºã›
6. å„ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãŒä»–ã®å‡¦ç†ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’åˆ†æã›ã‚ˆ

### ãƒ¬ãƒ™ãƒ«3: æ”¹å–„ææ¡ˆ
7. æœ€å°ã®å·¥æ•°ã§æœ€å¤§ã®åŠ¹æœã‚’å¾—ã‚‹æ”¹å–„æ¡ˆã‚’3ã¤ææ¡ˆã›ã‚ˆ
8. ä¸¦åˆ—å‡¦ç†ã«ã‚ˆã‚‹æ”¹å–„å¯èƒ½æ€§ã‚’æ¤œè¨ã›ã‚ˆ  
9. æ”¹å–„å¾Œã®äºˆæƒ³å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆç®—ã›ã‚ˆ

### ãƒ¬ãƒ™ãƒ«4: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ
10. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’ææ¡ˆã—ã€åŠ¹æœã‚’è©¦ç®—ã›ã‚ˆ
11. ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åˆ†å‰²ã«ã‚ˆã‚‹æ”¹å–„æ¡ˆã‚’æ¤œè¨ã›ã‚ˆ
12. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã§æ¤œçŸ¥ã™ã¹ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å®šç¾©ã›ã‚ˆ

---

## ğŸ’¡ å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆ

### Observabilityåˆ†æã®è¦ç‚¹
1. **Spanéšå±¤ã®ç†è§£**: è¦ªå­é–¢ä¿‚ã‹ã‚‰å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’æŠŠæ¡
2. **Durationåˆ†æ**: çµ¶å¯¾æ™‚é–“ã¨ç›¸å¯¾æ™‚é–“ã§ã®æ¯”è¼ƒ
3. **å±æ€§æ´»ç”¨**: ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’èª­ã¿å–ã‚Š
4. **ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜**: ç¹°ã‚Šè¿”ã—å‡¦ç†ã‚„ç•°å¸¸å€¤ã®ç™ºè¦‹

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ã®åŸå‰‡
1. **æ¸¬å®šâ†’åˆ†æâ†’æ”¹å–„â†’æ¤œè¨¼** ã®ã‚µã‚¤ã‚¯ãƒ«
2. **80-20ã®æ³•å‰‡**: 20%ã®æ”¹å–„ã§80%ã®åŠ¹æœ
3. **æ—©æœŸæœ€é©åŒ–ã®å›é¿**: æœ¬å½“ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã—ã¦ã‹ã‚‰
4. **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®è€ƒæ…®**: é€Ÿåº¦vsç²¾åº¦ã€ãƒ¡ãƒ¢ãƒªvsCPU

### å®Ÿå‹™ã¸ã®å¿œç”¨
- æœ¬ç•ªç’°å¢ƒã§ã®ç¶™ç¶šçš„ãªæ€§èƒ½ç›£è¦–
- ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ã®é©åˆ‡ãªè¨­å®š
- æ®µéšçš„ãªæ”¹å–„ã¨A/Bãƒ†ã‚¹ãƒˆ
- ãƒãƒ¼ãƒ é–“ã§ã®ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰

---

## ğŸ“š å‚è€ƒæƒ…å ±

### OpenTelemetryå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Tracing API](https://opentelemetry.io/docs/instrumentation/python/manual/#traces)
- [Span Attributes](https://opentelemetry.io/docs/specs/otel/trace/semantic_conventions/)

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æãƒ„ãƒ¼ãƒ«
- APMãƒ„ãƒ¼ãƒ«: Datadog, New Relic, Dynatrace
- ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©: py-spy, cProfile, line_profiler
- å¯è¦–åŒ–: Jaeger, Zipkin, OpenTelemetry Collector

ã“ã®æ¼”ç¿’ã‚’é€šã˜ã¦ã€å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã‚’ç‰¹å®šãƒ»è§£æ±ºã§ãã‚‹ã‚¹ã‚­ãƒ«ã‚’èº«ã«ä»˜ã‘ã¾ã—ã‚‡ã†ï¼
